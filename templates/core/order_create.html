{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .order-form {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .order-form h2 {
        color: #333;
        margin-bottom: 2rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #555;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }
    
    .order-item {
        background: #f8f9fa;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
    }
    
    .order-item-actions {
        margin-top: 1rem;
        text-align: right;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .btn-primary {
        background-color: #007bff;
        color: white;
        border: none;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="order-form">
    <h2>Nouvelle Commande</h2>
    
    <form method="post" id="orderForm">
        {% csrf_token %}
        
        <!-- Champ Client -->
        <div class="form-group">
            <label class="form-label">Client</label>
            <input type="text" name="client" class="form-control" required>
        </div>
        
        <!-- Liste des articles -->
        <div id="orderItems">
            <!-- Les articles seront ajoutés dynamiquement ici -->
        </div>
        
        <!-- Boutons d'action -->
        <div class="form-group">
            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                    <i class="fas fa-times"></i> Annuler
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// Initialiser les calculs pour les articles existants
window.addEventListener('DOMContentLoaded', () => {
    // Ajouter un premier article par défaut
    const orderItems = document.getElementById('orderItems');
    
    // Créer un nouvel élément pour l'article
    const item = document.createElement('div');
    item.className = 'order-item';
    
    // HTML pour l'article
    item.innerHTML = `
        <div class="form-row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Produit</label>
                <select name="products" class="form-control" onchange="updatePrice(this)">
                    <option value="">Sélectionnez un produit</option>
                    {% for product in products %}
                    <option value="{{ product.id }}" 
                        data-price="{{ product.price }}" 
                        data-stock="{{ product.quantity }}"
                        {% if product.quantity <= 0 %}disabled{% endif %}>
                        {{ product.name }} 
                        {% if product.quantity <= 0 %}
                            <span class="text-danger">(Hors stock)</span>
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Quantité</label>
                <input type="number" name="quantities" class="form-control" min="1" onchange="updatePrice(this)">
                <small class="text-danger stock-error d-none">Quantité maximale atteinte</small>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Prix total</label>
                <input type="number" name="prices" class="form-control" readonly>
            </div>
        </div>
    `;
    
    orderItems.appendChild(item);
});

// Fonction pour mettre à jour le prix et vérifier la quantité
function updatePrice(element) {
    // Trouver le conteneur de l'article
    const row = element.closest('.order-item');
    
    // Récupérer les éléments nécessaires
    const productSelect = row.querySelector('select[name="products"]').value;
    const quantityInput = row.querySelector('input[name="quantities"]');
    const priceInput = row.querySelector('input[name="prices"]');
    const stockError = row.querySelector('.stock-error');
    
    // Si aucun produit n'est sélectionné ou quantité invalide
    if (!productSelect || !quantityInput.value || quantityInput.value <= 0) {
        priceInput.value = '';
        return;
    }
    
    // Récupérer le prix du produit et la quantité en stock
    const productOption = row.querySelector(`select[name="products"] option[value="${productSelect}"]`);
    const productPrice = parseFloat(productOption.dataset.price);
    const productStock = parseInt(productOption.dataset.stock);
    
    // Vérifier la quantité maximale
    const quantity = parseInt(quantityInput.value);
    if (quantity > productStock) {
        quantityInput.value = productStock;
        stockError.classList.remove('d-none');
        stockError.textContent = `Quantité maximale atteinte (${productStock} disponible)`;
    } else {
        stockError.classList.add('d-none');
    }
    
    // Calculer et afficher le prix total
    const total = productPrice * quantity;
    priceInput.value = total.toFixed(2);
}

// Vérifier la quantité maximale au chargement du formulaire
window.addEventListener('DOMContentLoaded', () => {
    const quantityInputs = document.querySelectorAll('input[name="quantities"]');
    const productSelects = document.querySelectorAll('select[name="products"]');
    
    quantityInputs.forEach(input => {
        input.addEventListener('input', (e) => {
            const row = e.target.closest('.order-item');
            const productSelect = row.querySelector('select[name="products"]').value;
            const productOption = row.querySelector(`select[name="products"] option[value="${productSelect}"]`);
            const productStock = parseInt(productOption.dataset.stock);
            
            if (e.target.value > productStock) {
                e.target.value = productStock;
            }
        });
    });
    
    productSelects.forEach(select => {
        select.addEventListener('change', () => {
            const row = select.closest('.order-item');
            const quantityInput = row.querySelector('input[name="quantities"]');
            const productOption = select.querySelector(`option[value="${select.value}"]`);
            const productStock = parseInt(productOption.dataset.stock);
            
            if (quantityInput.value > productStock) {
                quantityInput.value = productStock;
            }
        });
    });
});
</script>
{% endblock %}
